{% extends 'base.html' %}
~
{% block title %}
  API Keys
{% endblock %}

{% block head %}
  <link rel='stylesheet' href='{{ url_buster('/static/css/key.css') }}'>
  {#<link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css'>#}
{% endblock %}

{% block scripts %}
  <script src='{{ url_buster('/static/js/key.js') }}'></script>
  {#<script src='https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js'></script>#}
{% endblock %}

{% block header %}
  <h1 aria-label>API Keys
    <a href='{{ url('/ui/help#keys') }}' target='_blank'>
      <i class='bi bi-question-circle help-button'></i>
    </a>
  </h1>
{% endblock %}

{% block content %}

  <div class='header-container'
       data-highlight-menu='key'
  >
  </div>

  <div class='indent'>
    {% if not key_list %}
      <p>
        You have not created any API keys yet.
      </p>
    {% else %}
      <div class='main-grid'>
        {% for key in key_list %}
          <div class='key-grid'>
            <div class='key-header'>
              {#<div class='grid-header'>#}
              <div class='d-flex flex-row align-items-center justify-content-between gap-2'>
                <div class='grid-title mr-auto p-2'>Key</div>
                {# Copy Key ID #}
                {#<div class='flex-space-between'>#}
                  <div class='edi-id-parent'>
                    <div class='edi-id-child-text'>
                      {{ key.key_id }}
                    </div>
                    <div class='edi-id-child-icon'>
                      <img src='{{ url('/static/svg/copy.svg') }}'
                           alt='Copy key'
                           class='edi-id-copy-button'
                      >
                    </div>
                  </div>
                  {# Edit Key button #}
                  <button type='button' class='icon-text-button'
                          data-bs-toggle='modal'
                          data-bs-target='#editKeyModal'
                          data-form-target='{{ url('/ui/api/key/update') }}'
                          data-title='Update API key'
                          data-key-id='{{ key.key_id }}'
                          data-key-description='{{ key.description or '' }}'
                          data-key-valid-from='{{ key.valid_from }}'
                          data-key-valid-to='{{ key.valid_to }}'
                          data-submit-text='Update'
                  >
                    <i class='bi bi-pencil'></i>
                  </button>

                  <button class='icon-text-button'
                          data-bs-toggle='modal'
                          data-bs-target='#deleteKeyModal'
                          data-key-id='{{ key.key_id }}'
                          data-key-description='{{ key.description or '' }}'
                  >
                    <i class='bi bi-lock'></i>
                    <span>Revoke</span>
                  </button>
                {#</div>#}
              </div> {# d-flex flex-row #}
            </div> {# key-header #}

            <div class='grid-title'>Description</div>
            <div class='grid-wrap'>{{ key.description or '' }}</div>

            <div class='grid-title'>Valid From</div>
            <div>{{ key.valid_from }}</div>

            <div class='grid-title'>Valid To</div>
            <div>{{ key.valid_to }}</div>

            <div class='grid-title'>Updated</div>
            <div>{{ key.updated }}</div>

            <div class='grid-title'>Duration</div>
            <div>{{ key.duration }}</div>

            <div class='grid-title'>Last Used</div>
            <div>{{ key.last_used or 'Never' }}</div>

            <div class='grid-title'>Use Count</div>
            <div>{{ key.use_count }}</div>

            <div class='grid-title'>Access type</div>
            <div>{{ key.access_type }}</div>


            <div class='grid-title'>Active</div>
            <div class='d-flex flex-row align-items-center justify-content-between gap-2'>
              {% if key.active %}
                <i class='bi bi-check-circle text-success' title='Active'></i>
              {% else %}
                <i class='bi bi-x-circle text-danger' title='Expired'></i>
              {% endif %}
            </div>
            {# d-flex flex-row #}
          </div> {# key-grid #}
        {% endfor %}
      </div> {# main-grid #}
    {% endif %}

    {# New Key button #}
    <button type='button' class='btn btn-primary' id='newKeyButton'
            data-bs-toggle='modal'
            data-bs-target='#editKeyModal'
            data-form-target='{{ url('/ui/api/key/new') }}'
            data-title='Create a new API key'
            data-key-id=''
            data-key-description=''
            data-key-valid-from='{{ now }}'
            data-key-valid-to='{{ now_plus_one_year }}'
            data-submit-text='Add'
    >
      New Key
    </button>

  </div>

  {# New/edit key modal #}
  <div class='modal fade' id='editKeyModal' tabindex='-1' data-bs-backdrop='static'>
    <div class='modal-dialog modal-dialog-centered'>
      <div class='modal-content'>
        <div class='modal-header'>
          <h5 class='modal-title' id='keyTitle'></h5>
          <button type='button' class='btn-close' data-bs-dismiss='modal'
                  aria-label='Close'></button>
        </div>
        <div class='modal-body'>
          <form method='post' id='keyForm' class='needs-validation' novalidate>
            <input type='hidden' id='keyId' name='key-id'>
            <div class='form-group'>
              <label for='keyDescription'>Description</label>
              <div class='grid-child-span-all'>
                <input type='text' class='form-control' id='keyDescription'
                       name='key-description'
                       required
                       pattern='.{3,}'>
                <div class='invalid-feedback'>
                  Please provide a description for the key.
                </div>
              </div>
            </div>

            <div class='form-group'>
              <label for='keyAccessType'>Access</label>
              <select id='keyAccessType' class='form-select' required>
                <option value=''>Select access type</option>
                <option value='full'>
                  Full profile read/write access
                </option>
                {% for group in group_list %}
                  <option value=group.id>
                    Group: {{ group.name + ': ' + group.description }}
                  </option>
                {% endfor %}
              </select>
              <div class='invalid-feedback'>
                Please provide an access type for the key.
              </div>
            </div>

            <div class='form-group'>
              <div class='dialog-grid'>
                <label for='keyValidFrom'>Valid from</label>
                <label for='keyValidTo'>Valid to</label>
                <div>
                  <input type='date' class='form-control' id='keyValidFrom' name='key-valid-from'
                         required>
                  <div id='fromDateFeedback' class='invalid-feedback'>
                    Invalid date.
                  </div>
                </div>
                <div>
                  <input type='date' class='form-control' id='keyValidTo' name='key-valid-to'
                         required>
                  <div class='invalid-feedback'>
                    Invalid date.
                  </div>
                </div>
              </div>
            </div>

            <div class='form-group'>
              <label for='keyDurationDisplay'>Duration</label>
              <div></div>
              <div class='grid-child-span-all'>
                <input type='text' class='form-control' id='keyDurationDisplay'
                       name='key-valid-display'
                       disabled>
              </div>
            </div>

            <div class='modal-footer'>
              <button type='button' class='btn btn-secondary' data-bs-dismiss='modal'>Cancel
              </button>
              <button type='submit' class='btn btn-primary' id='keySubmitButton'></button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  {# Delete key modal #}
  <div class='modal fade' id='deleteKeyModal' tabindex='-1' data-bs-backdrop='static'>
    <div class='modal-dialog modal-dialog-centered'>
      <div class='modal-content'>
        <div class='modal-header'>
          <h5 class='modal-title'>Remove Key</h5>
          <button type='button' class='btn-close' data-bs-dismiss='modal'
                  aria-label='Close'></button>
        </div>
        <div class='modal-body'>
          <form action='{{ url('/ui/api/key/delete') }}' method='post' id='deleteKeyForm'>
            <input type='hidden' id='deleteKeyId' name='key-id'>
            <div class='form-group'>
              <p>
                <span>Are you sure you want to remove key </span>
                '<span id='deleteKeyDescription' class='highlight'></span>'?
                <span>
                </span>
              </p>
              <p>
                <strong>Note:</strong>
                Any access granted by this API key will be revoked.
              </p>
            </div>
            <div class='modal-footer'>
              <button type='button' class='btn btn-secondary' data-bs-dismiss='modal'>Cancel
              </button>
              <button type='submit' class='btn btn-danger'>Remove</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

{% endblock %}
